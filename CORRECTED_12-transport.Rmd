---
title: "Werth_Code_FINAL"
author: "Stephen Werth"
date: "Feb 24, 2020"
output: html_document
---

**FINAL PROJECT**

**Hello Professor**

**For the Final project I chose to do Option #2, and I chose to do Chapter 12-Transportation**

**There are only 2 issues in this code both of which are caused by the same issue a function that no longer works and create the same error:**

  - *Error in match.fun(route_fun) : object 'route_osrm' not found*

**This issues and how to fix them are listed below in the code**


**PLEASE NOTE: I deleted the text that was originally in this github rmd file to save space and make things easier for your to review. I also included the excercises at the end with my answers/solutions**

```{r 12-transport-1, message=FALSE, results='hide'}
library(sf)
library(dplyr)
library(spDataLarge)
library(stplanr)      # geographic transport data package
library(tmap)         # visualization package (see Chapter 8)
```


```{r 12-transport-2, echo=FALSE, eval=FALSE}
# code that generated the input data - see also ?bristol_ways
# source("https://github.com/Robinlovelace/geocompr/raw/master/code/12-transport-data-gen.R") 
# view input data
summary(bristol_ways)
summary(bristol_ttwa)
summary(bristol_region)

region_all = rbind(bristol_region, bristol_ttwa)
library(tmap)
tmap_mode("view")
qtm(bristol_ways, lines.col = "highway", lines.lwd = 3, lines.palette = c("green", "black", "red")) +
  tm_scale_bar() +
  tm_shape(region_all) +
  tm_borders(lwd = c(5, 7), col = "darkblue")
```

```{r bristol, echo=FALSE, fig.cap="Bristol's transport network represented by colored lines for active (green), public (railways, black) and private motor (red) modes of travel. Blue border lines represent the inner city boundary and the larger Travel To Work Area (TTWA).", fig.scap="Bristol's transport network."}
knitr::include_graphics("figures/bristol.png")
 #knitr::include_graphics("https://user-images.githubusercontent.com/1825120/34452756-985267de-ed3e-11e7-9f59-fda1f3852253.png")
```


```{r 12-transport-3, eval=FALSE, echo=FALSE}
if(!require(readODS)) {
  install.packages("readODS")
}
u = "https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/536823/local-area-walking-and-cycling-in-england-2015.zip"
download.file(u, "local-area-walking-and-cycling-in-england-2015.zip")
unzip("local-area-walking-and-cycling-in-england-2015.zip")
View(readODS::read_ods("Table index.ods"))
cw0103 = readODS::read_ods("cw0103.ods")
View(cw0103)
```


```{block 12-transport-4, type='rmdnote'}
Another issue with small zones is related to anonymity rules.
To make it impossible to infer the identity of individuals in zones, detailed socio-demographic variables are often only available at a low geographic resolution. 
Breakdowns of travel mode by age and sex, for example, are available at the Local Authority level in the UK, but not at the much higher Output Area level, each of which contains around 100 households.
For further details, see www.ons.gov.uk/methodology/geography.
```

```{r 12-transport-5}
names(bristol_zones)
```

```{r 12-transport-6}
nrow(bristol_od)
nrow(bristol_zones)
```



```{r 12-transport-7}
zones_attr = bristol_od %>% 
  group_by(o) %>% 
  summarize_if(is.numeric, sum) %>% 
  dplyr::rename(geo_code = o)
```


```{r 12-transport-8}
summary(zones_attr$geo_code %in% bristol_zones$geo_code)
```


```{r 12-transport-9}
zones_joined = left_join(bristol_zones, zones_attr, by = "geo_code")
sum(zones_joined$all)
names(zones_joined)
```


```{r 12-transport-10}
zones_od = bristol_od %>% 
  group_by(d) %>% 
  summarize_if(is.numeric, sum) %>% 
  dplyr::select(geo_code = d, all_dest = all) %>% 
  inner_join(zones_joined, ., by = "geo_code")
```


```{r 12-transport-11, eval=FALSE}
qtm(zones_od, c("all", "all_dest")) +
  tm_layout(panel.labels = c("Origin", "Destination"))
```

```{r zones, echo=FALSE, fig.cap="Number of trips (commuters) living and working in the region. The left map shows zone of origin of commute trips; the right map shows zone of destination (generated by the script 12-zones.R).", message=FALSE, fig.scap="Number of trips (commuters) living and working in the region."}
source("https://github.com/Robinlovelace/geocompr/raw/master/code/12-zones.R", print.eval = TRUE)
```


```{r 12-transport-12}
od_top5 = bristol_od %>% 
  arrange(desc(all)) %>% 
  top_n(5, wt = all)
```

```{r od, echo=FALSE}
od_top5 %>% 
  knitr::kable(
    caption = paste("Sample of the top 5 origin-destination pairs in the",
                    "Bristol OD data frame, representing travel desire",
		    "lines between zones in the study area."),
    caption.short = "Sample of the origin-destination data.",
    booktabs = TRUE)
```


```{r 12-transport-13}
bristol_od$Active = (bristol_od$bicycle + bristol_od$foot) /
  bristol_od$all * 100
```


```{r 12-transport-14}
od_intra = filter(bristol_od, o == d)
od_inter = filter(bristol_od, o != d)
```


```{r 12-transport-15, warning=FALSE}
desire_lines = od2line(od_inter, zones_od)
```


```{r 12-transport-16, eval=FALSE}
qtm(desire_lines, lines.lwd = "all")
```

```{r desire, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Desire lines representing trip patterns in Bristol, with width representing number of trips and color representing the percentage of trips made by active modes (walking and cycling). The four black lines represent the interzonal OD pairs in Table 7.1.", fig.asp=0.8, fig.scap="Desire lines representing trip patterns in Bristol."}
source("https://github.com/Robinlovelace/geocompr/raw/master/code/12-desire.R", print.eval = TRUE)
```


```{r 12-transport-17, message=FALSE}
desire_lines$distance = as.numeric(st_length(desire_lines))
desire_carshort = dplyr::filter(desire_lines, car_driver > 300 & distance < 5000)
```


**1st ISSUE**

**ERROR:** *Error in match.fun(route_fun) : object 'route_osrm' not found*

**Note:**

  - **The equation below doesnt work. The author of the book realized the function no longer works and included "route_carshort" as part of the package for the book**


**THE FIX:**

  - **Since the author of the text created "route_carshort" as part of the package for his book then all we have to do is hash out the line as it's no longer needed**
  

```{r 12-transport-18, eval=FALSE}
#no longer needed so this line is hashed out
#route_carshort = line2route(desire_carshort, route_fun = route_osrm)
```


```{r 12-transport-19}
desire_carshort$geom_car = st_geometry(route_carshort)
```


```{r routes, warning=FALSE, fig.cap="Routes along which many (300+) short (<5km Euclidean distance) car journeys are made (red) overlaying desire lines representing the same trips (black) and zone centroids (dots).", echo=FALSE, eval=FALSE, fig.scap="Routes along which many car journeys are made."}
# commented-out as it adds little to the chapter (RL)
plot(st_geometry(desire_carshort))
plot(desire_carshort$geom_car, col = "red", add = TRUE)
plot(st_geometry(st_centroid(zones_od)), add = TRUE)
```

```{r 12-transport-20}
desire_rail = top_n(desire_lines, n = 3, wt = train)
```

```{r 12-transport-21}
ncol(desire_rail)
desire_rail = line_via(desire_rail, bristol_stations)
ncol(desire_rail)
```

```{r stations, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Station nodes (red dots) used as intermediary points that convert straight desire lines with high rail usage (black) into three legs: to the origin station (red) via public transport (gray) and to the destination (a very short blue line).", fig.scap="Station nodes."}
zone_cents = st_centroid(zones_od)
zone_cents_rail = zone_cents[desire_rail, ]
plot(desire_rail$geometry, expandBB = c(.1, .1, .1, .1))
plot(desire_rail$leg_orig, add = TRUE, col = "red", lwd = 3)
plot(desire_rail$leg_via, add = TRUE, col = "gray", lwd = 2)
plot(bristol_stations, add = TRUE, col = "red")
plot(desire_rail$leg_dest, add = TRUE, col = "blue", lwd = 5)
plot(zone_cents_rail, add = TRUE, col = "black")
# library(tmap)
# tmap_mode("plot")
# qtm(bristol_stations, basemaps = "https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=feae177da543411c9efa64160305212d", dots.col = "red", symbols.size = 2) +
#   tm_shape(desire_rail) +
#   tm_lines(col = "black", lwd = 4) +
#   tm_shape(legs) +
#   tm_lines()
```


```{r 12-transport-22}
summary(bristol_ways)
```


```{r 12-transport-23}
ways_freeway = bristol_ways %>% filter(maxspeed == "70 mph") 
ways_sln = SpatialLinesNetwork(ways_freeway)
slotNames(ways_sln)
weightfield(ways_sln)
class(ways_sln@g)
```


```{r wayssln, fig.cap="Illustration of a small route network, with segment thickness proportional to its betweenness, generated using the igraph package and described in the text.", fig.asp=0.8, out.width="60%", fig.scap="Illustration of a small route network."}
e = igraph::edge_betweenness(ways_sln@g)
plot(ways_sln@sl$geometry, lwd = e / 500)
```

```{r 12-transport-24, eval=FALSE, echo=FALSE}
# not producing groups of routes so removing for now...
m = igraph::clusters(ways_sln@g)
igraph::V(ways_sln@g)$m = m$membership
gdf = igraph::as_long_data_frame(ways_sln@g)
```





**2nd ISSUE**

**ERROR:** *Error in match.fun(route_fun) : object 'route_osrm' not found*

**Note:**

  - **This is the same issue as the first: The equation below doesnt work. The author of the book realized the function no longer works and included "route_rail" as part of the package for the book**


**THE FIX:**

  - **Just like the first issue, Since the author of the text created "route_rail" as part of the package for his book then all we have to do is hash out the line as it's no longer needed**


```{r 12-transport-25, eval=FALSE}
#Code below is no longer needed so we can hash it out

#route_rail = desire_rail %>% 
#  st_set_geometry("leg_orig") %>% 
#  line2route(route_fun = route_osrm) %>% 
#  st_set_crs(4326)
```


```{r 12-transport-26}
route_cycleway = rbind(route_rail, route_carshort)
route_cycleway$all = c(desire_rail$all, desire_carshort$all)
```

```{r 12-transport-27, eval=FALSE, echo=FALSE}
n_trips = route_cycleway$all / 100
plot(route_cycleway["distance"], lwd = n_trips)
```


```{r 12-transport-28, eval=FALSE}
qtm(route_cycleway, lines.lwd = "all")
```

```{r cycleways, echo=FALSE, message=FALSE, fig.cap="Potential routes along which to prioritise cycle infrastructure in Bristol, based on access key rail stations (red dots) and routes with many short car journeys (north of Bristol surrounding Stoke Bradley). Line thickness is proportional to number of trips.", fig.asp=0.8, out.width="70%", fig.scap="Routes along which to prioritise cycle infrastructure."}
source("https://github.com/Robinlovelace/geocompr/raw/master/code/12-cycleways.R")
m_leaflet
# tmap_leaflet(m_leaflet) # not working
# online figure - backup
# u = "https://user-images.githubusercontent.com/1825120/39901156-a8ec9ef6-54be-11e8-94fb-0b5f6b48775e.png"
```

**Exercises** 

**1. What is the total distance of cycleways that would be constructed if all the routes presented in Figure 12.6 were to be constructed?**
    -**Bonus: find two ways of arriving at the same answer.**

```{r 12-transport-29, eval=TRUE, echo=TRUE}
#around 42,000 m
sum(route_cycleway$distance)
sum(st_length(route_cycleway))
```

**2.  What proportion of trips represented in the desire_lines are accounted for in the route_cycleway object?**
    -**Bonus: what proportion of trips cross the proposed routes?**
    -**Advanced: write code that would increase this proportion.**

```{r 12-transport-30, echo=TRUE, eval=TRUE}
#around 2% 
sum(route_cycleway$all) / sum(desire_lines$all) 
d_intersect = desire_lines[route_cycleway, , op = st_crosses]
sum(d_intersect$all) / sum(desire_lines$all)

```


**3. The analysis presented in this chapter is designed for teaching how geocomputation methods can be applied to transport research. If you were to do this ‘for real’ for local government or a transport consultancy, what top 3 things would you do differently?**


  -*The top three things I would probably have to do differntly are the following:*
    
  -*1) I would have to come up with code that is able to actually fix the code in this book. The current fix is more of what i would consider a "bandaid" as the author of the text realized the issue and made "route_carshort" and  "route_rail" as objects within "spDataLarge" these work for this code but if we where to ever apply this to new data then it wouldnt work.*
  
  -*2) Depending on the "quality" or level of detail the client was wanting i might have to consider using a higher level of geographic resolution that is able to pull in and include more detail.*
  
  -*3) Also depending on the clients needs I might also consider adding OSM (Open Street Map) details. In this case study example, I believe one of the goals is partially based around the idea of how do we increase cycling in bristol to promote healthier life styles, so maybe adding details of parks or other healthy living type places along cycling paths might be a good idea. Perhaps we could even add bicycle shops along or near paths incase people get flats*


**4. Clearly, the routes identified in Figure 12.6 only provide part of the picture. How would you extend the analysis to incorporate more trips that could potentially be cycled?**


  *I would extend the analysis of this case study by first looking at what kind of people are more likely to bike. I would imagine if we were to find the ideal locations that have people that are more likely to bike then we could focus in on those people and areas. As an example I would imagine that people who live within walking/biking distance to their jobs such as in the denser parts of Bristol then we might find areas we could focus on, and perhaps we could achieve better results. So I guess it would sorta be like a customer clone model except for finding people more likly to adopt the whole cycling lifestyle.**
  
  *This extention on the analysis could also potentially help us pick areas that might be good candidates for additional cycling paths or help us find areas on the street that should be protected for cycling (dedicated cycle paths) and thus help increase the overall cyclers as they might feel safer to cycle instead of driving**


**5. Imagine that you want to extend the scenario by creating key areas (not routes) for investment in place-based cycling policies such as car-free zones, cycle parking points and reduced car parking strategy. How could raster data assist with this work?**
  -**Bonus: develop a raster layer that divides the Bristol region into 100 cells (10 by 10) and provide a metric related to transport policy, such as number of people trips that pass through each cell by walking or the average speed limit of roads, from the bristol_ways dataset (the approach taken in Chapter 13).**


  *Just like what I mentioned in my answer to question #4 If I were to extend the analysis of this case study by first looking at what kind of people are more likely to bike and the areas and the routes they might take then Raster data might help by providing us some areas with higher cycling potential at an aggregated level that would could focus on and potentialy invest in. Doing this would help us ensure that we spend investment dollars wisely.*


